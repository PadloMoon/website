{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.concat = void 0;\n\nconst xstream_1 = require(\"xstream\");\n/**\n * An implementation of concat that buffers all source stream events\n *\n * Marble diagram:\n *\n * ```text\n * --1--2---3---4-|\n * -a--b-c--d-|\n * --------X---------Y---------Z-\n *           concat\n * --1--2---3---4-abcdXY-------Z-\n * ```\n *\n * This is inspired by RxJS's concat as documented at http://rxmarbles.com/#concat and behaves\n * differently than xstream's concat as discussed in https://github.com/staltz/xstream/issues/170.\n *\n */\n\n\nfunction concat() {\n  for (var _len = arguments.length, streams = new Array(_len), _key = 0; _key < _len; _key++) {\n    streams[_key] = arguments[_key];\n  }\n\n  const subscriptions = new Array();\n  const queues = new Array(); // one queue per stream\n\n  const completedStreams = new Set();\n  let activeStreamIndex = 0;\n\n  function reset() {\n    while (subscriptions.length > 0) {\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      const subscription = subscriptions.shift();\n      subscription.unsubscribe();\n    }\n\n    queues.length = 0;\n    completedStreams.clear();\n    activeStreamIndex = 0;\n  }\n\n  const producer = {\n    start: listener => {\n      streams.forEach(_ => queues.push([]));\n\n      function emitAllQueuesEvents(streamIndex) {\n        // eslint-disable-next-line no-constant-condition\n        while (true) {\n          const element = queues[streamIndex].shift();\n\n          if (element === undefined) {\n            return;\n          }\n\n          listener.next(element);\n        }\n      }\n\n      function isDone() {\n        return activeStreamIndex >= streams.length;\n      }\n\n      if (isDone()) {\n        listener.complete();\n        return;\n      }\n\n      streams.forEach((stream, index) => {\n        subscriptions.push(stream.subscribe({\n          next: value => {\n            if (index === activeStreamIndex) {\n              listener.next(value);\n            } else {\n              queues[index].push(value);\n            }\n          },\n          complete: () => {\n            completedStreams.add(index);\n\n            while (completedStreams.has(activeStreamIndex)) {\n              // this stream completed: emit all and move on\n              emitAllQueuesEvents(activeStreamIndex);\n              activeStreamIndex++;\n            }\n\n            if (isDone()) {\n              listener.complete();\n            } else {\n              // now active stream can have some events queued but did not yet complete\n              emitAllQueuesEvents(activeStreamIndex);\n            }\n          },\n          error: error => {\n            listener.error(error);\n            reset();\n          }\n        }));\n      });\n    },\n    stop: () => {\n      reset();\n    }\n  };\n  return xstream_1.Stream.create(producer);\n}\n\nexports.concat = concat;","map":{"version":3,"mappings":";;;;;;;AAAA;AAEA;;;;;;;;;;;;;;;;;;;AAiBA,SAAgBA,MAAhB,GAAsD;AAAA,oCAAzBC,OAAyB;AAAzBA,WAAyB;AAAA;;AACpD,QAAMC,aAAa,GAAG,IAAIC,KAAJ,EAAtB;AACA,QAAMC,MAAM,GAAG,IAAID,KAAJ,EAAf,CAFoD,CAEnB;;AACjC,QAAME,gBAAgB,GAAG,IAAIC,GAAJ,EAAzB;AACA,MAAIC,iBAAiB,GAAG,CAAxB;;AAEA,WAASC,KAAT,GAAc;AACZ,WAAON,aAAa,CAACO,MAAd,GAAuB,CAA9B,EAAiC;AAC/B;AACA,YAAMC,YAAY,GAAGR,aAAa,CAACS,KAAd,EAArB;AACAD,kBAAY,CAACE,WAAb;AACD;;AAEDR,UAAM,CAACK,MAAP,GAAgB,CAAhB;AACAJ,oBAAgB,CAACQ,KAAjB;AACAN,qBAAiB,GAAG,CAApB;AACD;;AAED,QAAMO,QAAQ,GAAgB;AAC5BC,SAAK,EAAGC,QAAD,IAAa;AAClBf,aAAO,CAACgB,OAAR,CAAiBC,CAAD,IAAOd,MAAM,CAACe,IAAP,CAAY,EAAZ,CAAvB;;AAEA,eAASC,mBAAT,CAA6BC,WAA7B,EAAgD;AAC9C;AACA,eAAO,IAAP,EAAa;AACX,gBAAMC,OAAO,GAAGlB,MAAM,CAACiB,WAAD,CAAN,CAAoBV,KAApB,EAAhB;;AACA,cAAIW,OAAO,KAAKC,SAAhB,EAA2B;AACzB;AACD;;AACDP,kBAAQ,CAACQ,IAAT,CAAcF,OAAd;AACD;AACF;;AAED,eAASG,MAAT,GAAe;AACb,eAAOlB,iBAAiB,IAAIN,OAAO,CAACQ,MAApC;AACD;;AAED,UAAIgB,MAAM,EAAV,EAAc;AACZT,gBAAQ,CAACU,QAAT;AACA;AACD;;AAEDzB,aAAO,CAACgB,OAAR,CAAgB,CAACU,MAAD,EAASC,KAAT,KAAkB;AAChC1B,qBAAa,CAACiB,IAAd,CACEQ,MAAM,CAACE,SAAP,CAAiB;AACfL,cAAI,EAAGM,KAAD,IAAU;AACd,gBAAIF,KAAK,KAAKrB,iBAAd,EAAiC;AAC/BS,sBAAQ,CAACQ,IAAT,CAAcM,KAAd;AACD,aAFD,MAEO;AACL1B,oBAAM,CAACwB,KAAD,CAAN,CAAcT,IAAd,CAAmBW,KAAnB;AACD;AACF,WAPc;AAQfJ,kBAAQ,EAAE,MAAK;AACbrB,4BAAgB,CAAC0B,GAAjB,CAAqBH,KAArB;;AAEA,mBAAOvB,gBAAgB,CAAC2B,GAAjB,CAAqBzB,iBAArB,CAAP,EAAgD;AAC9C;AACAa,iCAAmB,CAACb,iBAAD,CAAnB;AACAA,+BAAiB;AAClB;;AAED,gBAAIkB,MAAM,EAAV,EAAc;AACZT,sBAAQ,CAACU,QAAT;AACD,aAFD,MAEO;AACL;AACAN,iCAAmB,CAACb,iBAAD,CAAnB;AACD;AACF,WAvBc;AAwBf0B,eAAK,EAAGA,KAAD,IAAU;AACfjB,oBAAQ,CAACiB,KAAT,CAAeA,KAAf;AACAzB,iBAAK;AACN;AA3Bc,SAAjB,CADF;AA+BD,OAhCD;AAiCD,KAzD2B;AA0D5B0B,QAAI,EAAE,MAAK;AACT1B,WAAK;AACN;AA5D2B,GAA9B;AA+DA,SAAO2B,iBAAOC,MAAP,CAActB,QAAd,CAAP;AACD;;AAlFDuB","names":["concat","streams","subscriptions","Array","queues","completedStreams","Set","activeStreamIndex","reset","length","subscription","shift","unsubscribe","clear","producer","start","listener","forEach","_","push","emitAllQueuesEvents","streamIndex","element","undefined","next","isDone","complete","stream","index","subscribe","value","add","has","error","stop","xstream_1","create","exports"],"sourceRoot":"","sources":["../src/concat.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}