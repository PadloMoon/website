{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.SocketWrapper = void 0;\n\nconst isomorphic_ws_1 = __importDefault(require(\"isomorphic-ws\"));\n\nfunction environmentIsNodeJs() {\n  return typeof process !== \"undefined\" && typeof process.versions !== \"undefined\" && typeof process.versions.node !== \"undefined\";\n}\n/**\n * A thin wrapper around isomorphic-ws' WebSocket class that adds\n * - constant message/error/open/close handlers\n * - explict connection via a connect() method\n * - type support for events\n * - handling of corner cases in the open and close behaviour\n */\n\n\nclass SocketWrapper {\n  constructor(url, messageHandler, errorHandler, openHandler, closeHandler) {\n    let timeout = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : 10000;\n    this.closed = false;\n    this.connected = new Promise((resolve, reject) => {\n      this.connectedResolver = resolve;\n      this.connectedRejecter = reject;\n    });\n    this.url = url;\n    this.messageHandler = messageHandler;\n    this.errorHandler = errorHandler;\n    this.openHandler = openHandler;\n    this.closeHandler = closeHandler;\n    this.timeout = timeout;\n  }\n  /**\n   * returns a promise that resolves when connection is open\n   */\n\n\n  connect() {\n    const socket = new isomorphic_ws_1.default(this.url);\n\n    socket.onerror = error => {\n      this.clearTimeout();\n\n      if (this.errorHandler) {\n        this.errorHandler(error);\n      }\n    };\n\n    socket.onmessage = messageEvent => {\n      this.messageHandler({\n        type: messageEvent.type,\n        data: messageEvent.data\n      });\n    };\n\n    socket.onopen = _ => {\n      this.clearTimeout(); // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n\n      this.connectedResolver();\n\n      if (this.openHandler) {\n        this.openHandler();\n      }\n    };\n\n    socket.onclose = closeEvent => {\n      this.closed = true;\n\n      if (this.closeHandler) {\n        this.closeHandler(closeEvent);\n      }\n    };\n\n    const started = Date.now();\n    this.timeoutId = setTimeout(() => {\n      socket.onmessage = () => 0;\n\n      socket.onerror = () => 0;\n\n      socket.onopen = () => 0;\n\n      socket.onclose = () => 0;\n\n      socket.close();\n      this.socket = undefined;\n      const elapsed = Math.floor(Date.now() - started); // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n\n      this.connectedRejecter(`Connection attempt timed out after ${elapsed} ms`);\n    }, this.timeout);\n    this.socket = socket;\n  }\n  /**\n   * Closes an established connection and aborts other connection states\n   */\n\n\n  disconnect() {\n    if (!this.socket) {\n      throw new Error(\"Socket undefined. This must be called after connecting.\");\n    }\n\n    this.clearTimeout();\n\n    switch (this.socket.readyState) {\n      case isomorphic_ws_1.default.OPEN:\n        this.socket.close(1000\n        /* Normal Closure */\n        );\n        break;\n\n      case isomorphic_ws_1.default.CLOSED:\n        // nothing to be done\n        break;\n\n      case isomorphic_ws_1.default.CONNECTING:\n        // imitate missing abort API\n        this.socket.onopen = () => 0;\n\n        this.socket.onclose = () => 0;\n\n        this.socket.onerror = () => 0;\n\n        this.socket.onmessage = () => 0;\n\n        this.socket = undefined;\n\n        if (this.closeHandler) {\n          this.closeHandler({\n            wasClean: false,\n            code: 4001\n          });\n        }\n\n        break;\n\n      case isomorphic_ws_1.default.CLOSING:\n        // already closing. Let it proceed\n        break;\n\n      default:\n        throw new Error(`Unknown readyState: ${this.socket.readyState}`);\n    }\n  }\n\n  async send(data) {\n    return new Promise((resolve, reject) => {\n      if (!this.socket) {\n        throw new Error(\"Socket undefined. This must be called after connecting.\");\n      }\n\n      if (this.closed) {\n        throw new Error(\"Socket was closed, so no data can be sent anymore.\");\n      } // this exception should be thrown by send() automatically according to\n      // https://developer.mozilla.org/de/docs/Web/API/WebSocket#send() but it does not work in browsers\n\n\n      if (this.socket.readyState !== isomorphic_ws_1.default.OPEN) {\n        throw new Error(\"Websocket is not open\");\n      }\n\n      if (environmentIsNodeJs()) {\n        this.socket.send(data, err => err ? reject(err) : resolve());\n      } else {\n        // Browser websocket send method does not accept a callback\n        this.socket.send(data);\n        resolve();\n      }\n    });\n  }\n  /**\n   * Clears the timeout function, such that no timeout error will be raised anymore. This should be\n   * called when the connection is established, a connection error occurred or the socket is disconnected.\n   *\n   * This method must not be called before `connect()`.\n   * This method is idempotent.\n   */\n\n\n  clearTimeout() {\n    if (!this.timeoutId) {\n      throw new Error(\"Timeout ID not set. This should not happen and usually means connect() was not called.\");\n    } // Note: do not unset this.timeoutId to allow multiple calls to this function\n\n\n    clearTimeout(this.timeoutId);\n  }\n\n}\n\nexports.SocketWrapper = SocketWrapper;","map":{"version":3,"mappings":"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","names":["environmentIsNodeJs","process","versions","node","SocketWrapper","constructor","url","messageHandler","errorHandler","openHandler","closeHandler","timeout","connected","Promise","resolve","reject","connectedResolver","connectedRejecter","connect","socket","isomorphic_ws_1","onerror","error","clearTimeout","onmessage","messageEvent","type","data","onopen","_","onclose","closeEvent","closed","started","Date","now","timeoutId","setTimeout","close","undefined","elapsed","Math","floor","disconnect","Error","readyState","OPEN","CLOSED","CONNECTING","wasClean","code","CLOSING","send","err","exports"],"sourceRoot":"","sources":["../src/socketwrapper.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}