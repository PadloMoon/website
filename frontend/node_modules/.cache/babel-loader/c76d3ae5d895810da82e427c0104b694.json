{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.lastValue = exports.asArray = exports.countStream = exports.Reducer = void 0; // Reducer takes a stream of events T and a ReducerFunc, that\n// materializes a state of type U.\n\nclass Reducer {\n  constructor(stream, reducer, initState) {\n    this.stream = stream;\n    this.reducer = reducer;\n    this.state = initState;\n    this.completed = new Promise((resolve, reject) => {\n      const subscription = this.stream.subscribe({\n        next: evt => {\n          this.state = this.reducer(this.state, evt);\n        },\n        complete: () => {\n          resolve(); // this must happen after resolve, to ensure stream.subscribe() has finished\n\n          subscription.unsubscribe();\n        },\n        error: err => {\n          reject(err); // the stream already closed on error, but unsubscribe to be safe\n\n          subscription.unsubscribe();\n        }\n      });\n    });\n  } // value returns current materialized state\n\n\n  value() {\n    return this.state;\n  } // finished resolves on completed stream, rejects on stream error\n\n\n  async finished() {\n    return this.completed;\n  }\n\n}\n\nexports.Reducer = Reducer;\n\nfunction increment(sum, _) {\n  return sum + 1;\n} // countStream returns a reducer that contains current count\n// of events on the stream\n\n\nfunction countStream(stream) {\n  return new Reducer(stream, increment, 0);\n}\n\nexports.countStream = countStream;\n\nfunction append(list, evt) {\n  return [...list, evt];\n} // asArray maintains an array containing all events that have\n// occurred on the stream\n\n\nfunction asArray(stream) {\n  return new Reducer(stream, append, []);\n}\n\nexports.asArray = asArray;\n\nfunction last(_, event) {\n  return event;\n} // lastValue returns the last value read from the stream, or undefined if no values sent\n\n\nfunction lastValue(stream) {\n  return new Reducer(stream, last, undefined);\n}\n\nexports.lastValue = lastValue;","map":{"version":3,"mappings":";;;;;sFAIA;AACA;;AACA,MAAaA,OAAb,CAAoB;AAQlBC,cAAmBC,MAAnB,EAAsCC,OAAtC,EAAkEC,SAAlE,EAA8E;AAC5E,SAAKF,MAAL,GAAcA,MAAd;AACA,SAAKC,OAAL,GAAeA,OAAf;AACA,SAAKE,KAAL,GAAaD,SAAb;AACA,SAAKE,SAAL,GAAiB,IAAIC,OAAJ,CAAkB,CAACC,OAAD,EAAUC,MAAV,KAAoB;AACrD,YAAMC,YAAY,GAAG,KAAKR,MAAL,CAAYS,SAAZ,CAAsB;AACzCC,YAAI,EAAGC,GAAD,IAAW;AACf,eAAKR,KAAL,GAAa,KAAKF,OAAL,CAAa,KAAKE,KAAlB,EAAyBQ,GAAzB,CAAb;AACD,SAHwC;AAIzCC,gBAAQ,EAAE,MAAK;AACbN,iBAAO,GADM,CAEb;;AACAE,sBAAY,CAACK,WAAb;AACD,SARwC;AASzCC,aAAK,EAAGC,GAAD,IAAa;AAClBR,gBAAM,CAACQ,GAAD,CAAN,CADkB,CAElB;;AACAP,sBAAY,CAACK,WAAb;AACD;AAbwC,OAAtB,CAArB;AAeD,KAhBgB,CAAjB;AAiBD,GA7BiB,CA+BlB;;;AACOG,OAAK;AACV,WAAO,KAAKb,KAAZ;AACD,GAlCiB,CAoClB;;;AACqB,QAARc,QAAQ;AACnB,WAAO,KAAKb,SAAZ;AACD;;AAvCiB;;AAApBc;;AA0CA,SAASC,SAAT,CAAsBC,GAAtB,EAAmCC,CAAnC,EAAuC;AACrC,SAAOD,GAAG,GAAG,CAAb;AACD,C,CAED;AACA;;;AACA,SAAgBE,WAAhB,CAA+BtB,MAA/B,EAAgD;AAC9C,SAAO,IAAIF,OAAJ,CAAYE,MAAZ,EAAoBmB,SAApB,EAA+B,CAA/B,CAAP;AACD;;AAFDD;;AAIA,SAASK,MAAT,CAAmBC,IAAnB,EAAuCb,GAAvC,EAA6C;AAC3C,SAAO,CAAC,GAAGa,IAAJ,EAAUb,GAAV,CAAP;AACD,C,CAED;AACA;;;AACA,SAAgBc,OAAhB,CAA2BzB,MAA3B,EAA4C;AAC1C,SAAO,IAAIF,OAAJ,CAA6BE,MAA7B,EAAqCuB,MAArC,EAA6C,EAA7C,CAAP;AACD;;AAFDL;;AAIA,SAASQ,IAAT,CAAiBL,CAAjB,EAAyBM,KAAzB,EAAiC;AAC/B,SAAOA,KAAP;AACD,C,CAED;;;AACA,SAAgBC,SAAhB,CAA6B5B,MAA7B,EAA8C;AAC5C,SAAO,IAAIF,OAAJ,CAA8BE,MAA9B,EAAsC0B,IAAtC,EAA4CG,SAA5C,CAAP;AACD;;AAFDX","names":["Reducer","constructor","stream","reducer","initState","state","completed","Promise","resolve","reject","subscription","subscribe","next","evt","complete","unsubscribe","error","err","value","finished","exports","increment","sum","_","countStream","append","list","asArray","last","event","lastValue","undefined"],"sourceRoot":"","sources":["../src/reducer.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}